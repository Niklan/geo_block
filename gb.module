<?php

/**
 * @file
 * Main module file.
 */

define('GB_DEFAULT_GEOSERVICE', 'ipgeobase');

/**
 * Implements hook_menu().
 */
function gb_menu() {
  $items['admin/structure/block/gb_configure'] = array(
    'title' => 'Geo block settings',
    'description' => 'Configure Geo block settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('gb_module_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'gb.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_form_block_add_block_form_alter().
 *
 * Add geo settings only to core block's.
 */
function gb_form_block_add_block_form_alter(&$form, &$form_state, $form_id) {
  if ($form['module']['#value'] == "block") {
    if (empty($form_state['num_cities'])) {
      $form_state['num_cities'] = 1;
    }

    $form['visibility']['geoblock'] = array(
      '#type' => 'fieldset',
      '#title' => t('Geo Settings'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#group' => 'visibility',
      '#weight' => 25,
      '#tree' => TRUE,
    );
    $form['visibility']['geoblock']['city_settings'] = array(
      '#type' => 'fieldset',
      '#title' => t('City settings'),
      '#description' => t('In this section you can configure the display of different materials for different cities.'),
      '#prefix' => '<div id="cities-fieldset-wrapper">',
      '#suffix' => '</div>',
      '#weight' => 0,
      '#tree' => TRUE,
    );

    for ($i = 1; $i <= $form_state['num_cities']; $i++) {
      $form['visibility']['geoblock']['city_settings'][$i] = array(
        '#type' => 'fieldset',
        '#title' => check_plain("City {$i}"),
      );
      $form['visibility']['geoblock']['city_settings'][$i]['cities'] = array(
        '#type' => 'textfield',
        '#title' => t('City'),
      );
      $form['visibility']['geoblock']['city_settings'][$i]['block_title'] = array(
        '#type' => 'textfield',
        '#title' => t('Block title'),
      );
      $form['visibility']['geoblock']['city_settings'][$i]['block_content'] = array(
        '#type' => 'text_format',
        '#title' => t('Block body'),
      );
    }

    $form['visibility']['geoblock']['city_settings']['add_name'] = array(
      '#type' => 'submit',
      '#value' => t('Add one more'),
      '#submit' => array('gb_form_block_admin_configure_alter_add_one'),
      '#ajax' => array(
        'callback' => 'gb_form_block_admin_configure_alter_callback',
        'wrapper' => 'cities-fieldset-wrapper',
      ),
    );
    if ($form_state['num_cities'] > 1) {
      $form['visibility']['geoblock']['city_settings']['remove_name'] = array(
        '#type' => 'submit',
        '#value' => t('Remove one'),
        '#submit' => array('gb_form_block_admin_configure_alter_remove_one'),
        '#ajax' => array(
          'callback' => 'gb_form_block_admin_configure_alter_callback',
          'wrapper' => 'cities-fieldset-wrapper',
        ),
      );
    }

    $form['#submit'][] = 'gb_form_block_admin_configure_alter_submit';
  }

  return $form;
}

/**
 * Implements hook_form_block_admin_configure_alter().
 *
 * Add geo settings only to core block's.
 */
function gb_form_block_admin_configure_alter(&$form, &$form_state) {
  if ($form['module']['#value'] == "block") {
    $default_data_query = db_select('geoblock', 'g')
        ->fields('g')
        ->condition('g.delta', $form['delta']['#value'])
        ->execute()
        ->fetchObject();

    if (!empty($default_data_query->data)) {
      $default_data = unserialize($default_data_query->data);
    }
    if (empty($form_state['num_cities'])) {
      $form_state['num_cities'] = 1;
      if (!empty($default_data)) {
        for ($i = 1; !empty($default_data[$i]); $i++) {
          $form_state['num_cities'] = $i;
        }
      }
    }

    $form['visibility']['geoblock'] = array(
      '#type' => 'fieldset',
      '#title' => t('Geo Settings'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#group' => 'visibility',
      '#weight' => 25,
      '#tree' => TRUE,
    );
    $form['visibility']['geoblock']['city_settings'] = array(
      '#type' => 'fieldset',
      '#title' => t('City settings'),
      '#description' => t('In this section you can configure the display of different materials for different cities.'),
      '#prefix' => '<div id="cities-fieldset-wrapper">',
      '#suffix' => '</div>',
      '#weight' => 0,
      '#tree' => TRUE,
    );

    for ($i = 1; $i <= $form_state['num_cities']; $i++) {
      $form['visibility']['geoblock']['city_settings'][$i] = array(
        '#type' => 'fieldset',
        '#title' => check_plain("City {$i}"),
      );
      $form['visibility']['geoblock']['city_settings'][$i]['cities'] = array(
        '#type' => 'textfield',
        '#title' => t('City'),
        '#default_value' => isset($default_data[$i]['cities']) ? $default_data[$i]['cities'] : '',
      );
      $form['visibility']['geoblock']['city_settings'][$i]['block_title'] = array(
        '#type' => 'textfield',
        '#title' => t('Block title'),
        '#default_value' => isset($default_data[$i]['block_title']) ? $default_data[$i]['block_title'] : '',
      );
      $form['visibility']['geoblock']['city_settings'][$i]['block_content'] = array(
        '#type' => 'text_format',
        '#title' => t('Block body'),
        '#default_value' => isset($default_data[$i]['block_content']['value']) ? $default_data[$i]['block_content']['value'] : '',
        '#format' => isset($default_data[$i]['block_content']['format']) ? $default_data[$i]['block_content']['format'] : 'filtered_html',
      );
    }

    $form['visibility']['geoblock']['city_settings']['add_name'] = array(
      '#type' => 'submit',
      '#value' => t('Add one more'),
      '#submit' => array('gb_form_block_admin_configure_alter_add_one'),
      '#ajax' => array(
        'callback' => 'gb_form_block_admin_configure_alter_callback',
        'wrapper' => 'cities-fieldset-wrapper',
      ),
    );
    if ($form_state['num_cities'] > 1) {
      $form['visibility']['geoblock']['city_settings']['remove_name'] = array(
        '#type' => 'submit',
        '#value' => t('Remove one'),
        '#submit' => array('gb_form_block_admin_configure_alter_remove_one'),
        '#ajax' => array(
          'callback' => 'gb_form_block_admin_configure_alter_callback',
          'wrapper' => 'cities-fieldset-wrapper',
        ),
      );
    }

    $form['#submit'][] = 'gb_form_block_admin_configure_alter_submit';
  }

  return $form;
}

/**
 * Selects and returns the fieldset with the data in it. Used by AJAX.
 */
function gb_form_block_admin_configure_alter_callback($form, $form_state) {
  return $form['visibility']['geoblock']['city_settings'];
}

/**
 * Handler button "Add one more".
 */
function gb_form_block_admin_configure_alter_add_one($form, &$form_state) {
  $form_state['num_cities']++;
  $form_state['rebuild'] = TRUE;
}

/**
 * Handler button "Remove one".
 */
function gb_form_block_admin_configure_alter_remove_one($form, &$form_state) {
  if ($form_state['num_cities'] > 1) {
    $form_state['num_cities']--;
  }
  $form_state['rebuild'] = TRUE;
}

/**
 * Handler button "Submit".
 */
function gb_form_block_admin_configure_alter_submit(&$form, &$form_state) {
  $check_data = db_select('geoblock', 'g')
      ->fields('g')
      ->condition('g.delta', $form_state['values']['delta'])
      ->execute()
      ->fetchObject();

  $data_to_save = $form_state['values']['geoblock']['city_settings'];

  // Unset values of buttons.
  unset($data_to_save['add_name']);
  unset($data_to_save['remove_name']);

  if (!empty($form_state['values']['geoblock']['city_settings'][1]['cities'])) {
    if (empty($check_data->delta)) {
      $query = db_insert('geoblock')
          ->fields(array(
            'delta' => $form_state['values']['delta'],
            'data' => serialize($data_to_save),
          ))
          ->execute();
    }
    else {
      $query = db_update('geoblock')
          ->fields(array(
            'data' => serialize($data_to_save),
          ))
          ->condition('delta', $form_state['values']['delta'])
          ->execute();
    }
  }
}

/**
 * Implements hook_form_block_custom_block_delete_alter().
 */
function gb_form_block_custom_block_delete_alter(&$form, &$form_state) {
  $form['#submit'][] = 'gb_form_block_custom_block_delete_alter_submit';
}

/**
 * Implements hook_form_block_custom_block_delete_alter_submit().
 */
function gb_form_block_custom_block_delete_alter_submit(&$form, &$form_state) {
  db_delete('geoblock')
      ->condition('delta', $form['bid']['#value'])
      ->execute();
}

/**
 * Returns information from database about geo block.
 */
function gb_block_get($delta) {
  return db_query("SELECT * FROM {geoblock} WHERE delta = :delta", array(':delta' => $delta))->fetchAssoc();
}

/**
 * Implements hook_block_view_alter().
 */
function gb_block_view_alter(&$data, $block) {
  if ($block->module == "block") {
    $geo_block = gb_block_generate_data($block->delta);
    if (!empty($geo_block)) {
      $block->title = $geo_block['subject'];
      $data['content'] = $geo_block['content'];

      return $data;
      return $block;
    }
    else {
      return $data;
    }
  }
}

/**
 * The function receives the user's city.
 *
 * @param string $geo_service
 *   Geo service to be used to determine the user's location.
 * @param string $ip
 *   Own IP address that will be determined by the location.
 */
function gb_get_user_city($geo_service = '', $ip = '') {
  if (empty($geo_service)) {
    $geo_service = variable_get('gb_geo_service', GB_DEFAULT_GEOSERVICE);
  }
  if (empty($ip)) {
    $ip = ip_address();
  }
  if (!isset($_COOKIE['gb_user_city'])) {
    switch ($geo_service) {
      case 'ipgeobase':
        $content = gb_get_user_city_ipgeobase($ip);
        break;

      case 'hostip':
        $content = gb_get_user_city_hostip($ip);
        break;
    }
    setcookie("gb_user_city", strtolower($content));
  }
  else {
    $content = urldecode($_COOKIE['gb_user_city']);
  }

  return $content;
}

/**
 * Generate subject and content for block.
 */
function gb_block_generate_data($delta = 1) {
  $block = gb_block_get($delta);
  $cities_data = unserialize($block['data']);
  $cities_in_block = count($cities_data);

  $subject = NULL;
  $content = NULL;
  $result = array();
  $user_city = strtolower(gb_get_user_city());
  for ($i = 1; $i <= $cities_in_block; $i++) {
    if (strtolower($cities_data[$i]['cities']) == $user_city) {
      $subject = !empty($cities_data[$i]['block_title']) ? $cities_data[$i]['block_title'] : NULL;
      $content_data = !empty($cities_data[$i]['block_content']['value']) ? $cities_data[$i]['block_content']['value'] : NULL;
      $content_format = !empty($cities_data[$i]['block_content']['format']) ? $cities_data[$i]['block_content']['format'] : NULL;
      $content = check_markup($content_data, $content_format, $langcode = '', $cache = FALSE);
    }
  }
  if ((empty($subject)) and (empty($content))) {
    $result = NULL;
  }
  else {
    $result['subject'] = $subject;
    $result['content'] = $content;
  }

  return $result;
}

/**
 * Get user location with service http://ipgeobase.ru/.
 *
 * @param string $ip
 *   IP to locate.
 */
function gb_get_user_city_ipgeobase($ip = '127.0.0.1') {
  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, "http://ipgeobase.ru:7020/geo?ip={$ip}");
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_HEADER, 0);
  $result = curl_exec($ch);
  curl_close($ch);

  $location = (array) simplexml_load_string($result);
  $user_city = $location['ip']->city;

  return $user_city;
}

/**
 * Get user location with service http://hostip.info/.
 *
 * @param string $ip
 *   IP to locate.
 */
function gb_get_user_city_hostip($ip = '127.0.0.1') {
  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, "http://api.hostip.info/get_json.php?ip={$ip}");
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_HEADER, 0);
  $result = curl_exec($ch);
  curl_close($ch);

  $location = json_decode($result);
  $user_city = $location->city;

  return $user_city;
}

/**
 * Implements hook_page_build().
 */
function gb_page_build(&$page) {
  $blocks_data = db_select('geoblock', 'g')
      ->fields('g')
      ->execute();
  foreach ($blocks_data as $block) {
    $blocks[] = $block;
  }
  if (!empty($blocks)) {
    $cities = array();
    for ($b = 0; $b < count($blocks); $b++) {
      $cities_data = unserialize($blocks[$b]->data);
      $cities_in_block = count($cities_data);
      for ($c = 1; $c <= $cities_in_block; $c++) {
        $curr_city = $cities_data[$c]['cities'];
        if (!in_array($curr_city, $cities)) {
          $cities[] .= $curr_city;
        }
      }
    }

    $user_city = gb_get_user_city();
    $text = t('Your location');

    drupal_add_js(array('cities' => $cities), 'setting');
    drupal_add_js(array('user_city' => $user_city), 'setting');
    drupal_add_js(array('text' => $text), 'setting');
    drupal_add_js(array('gb_top_toolbar_enabled' => variable_get('gb_top_toolbar_enabled', 0)), 'setting');
    drupal_add_js(array('gb_top_toolbar_usecookie' => variable_get('gb_top_toolbar_usecookie', 0)), 'setting');
    drupal_add_js(array('gb_top_toolbar_bgcolor' => variable_get('gb_top_toolbar_bgcolor', '#FEF0D5')), 'setting');
    drupal_add_js(array('gb_placeholder_enabled' => variable_get('gb_placeholder_enabled', 0)), 'setting');
    drupal_add_js(drupal_get_path('module', 'gb') . '/gb_city_select.js');
  }
}
